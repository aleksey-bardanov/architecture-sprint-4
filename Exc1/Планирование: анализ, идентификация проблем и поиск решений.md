# Планирование: анализ, идентификация проблем и поиск решений

Перед тем, как предлагать изменения требуется выявить проблемы существующей архитектуры. Для этого требуется провести анализ ее структуры, предположить какие из ранее принятых решений привели к текущим проблемам и сформулировать гипотезы о том, какие изменения должны улучшить ситуацию. 

## Текущее положение дел

- Система состоит из MES (manufacturing execution system), CRM (customer relationship management) и интернет магазина.
- Нагрузка растет линейно, темпы прироста - 100 заказов в месяц.
- При размещении заказа на платформе оценивается длительность выполнения заказа. Нормальный срок - порядка одного месяца.
- Открыт API MES для приема B2B заказов, теперь можно создать заказ через MES.
- MES куплен отдельно, чтобы рассчитывать стоимость изготовления изделий, взаимодействует с CRM через RabbitMQ.
- Расчет стоимости может занимать от 2 до 30 минут
- Операторы берут самые новые заказы, так как за них идет вознаграждение

## Проблемы, которые замечает бизнес

- Просроченные заказы. Время от размещения заказа на платформе до получения клиентом готового изделия может составлять несколько месяцев.
- Клиенты получают недостоверную информацию о сроках изготовления изделия. Реальные сроки не соответствуют оценке.
- Открытие B2B API привело к увеличению просроченных заказов.
- MES долго загружает список заказов в работе, отсортированный по статусам.
- B2B и B2C клиенты уходят.
- Редкие релизы из-за того, что долго чинятся баги.

## Предполагаемые проблемы в существующей архитектуре

На самом деле руководствуясь только описанием сложно делать однозначные выводы, однако вот на что стоит обратить внимание:   

- MES вероятно перегружен. Для обслуживания операторов MES осуществляет запросы напрямую к базе данных, одновременно выполняя калькуляцию стоимости изделий по синхронным и асинхронным запросам.
- Сервис MES осуществляет работу в разных доменах (оплата, изготовление). Чтобы взять заказ в работу, нужно чтобы CRM запросила у MES цену, а после этого можно будет изменить статус заказа и передать его на изготовление.
- Магазин и СRM пользуются одной базой данных, взаимодействуют через память, зависят от одной модели данных.

## Предлагаемые инициативы в порядке приоритета

Первыми идут наиболее приоритетные инициативы

- Чтобы проверить гипотезы требуется обеспечить наблюдаемость системы за счет внедрения решений по мониторингу, трейсингу, логированию. 
- Сократить количество обращений к БД MES при помощи кеша
- Отделить расчет стоимости изделия от управления производством
- Разделить БД  CRM и магазина

### Целевая архитектура через пол года

Текущая архитектура системы представлена на [диаграмме](/CurretnArchitecture.puml).
Целевая архитектура представлена на [диаграмме](/TargetArchitecture.puml)

### Самые основные изменения

- Асинхронная коммуникация между доменами. Магазин, оформление заказов и производство разделены и взаимодействуют через брокер сообщений.
- Расчет стоимости отделен от управления производством. Сделать это можно не переписывая MES, просто подняв дополнительный экземпляр приложения и используя только функционал расчета стоимости. Это потребует доработки API CRM и использования API Gateway для обеспечения перехода от предыдущего способа обработки заказов, но это позволит иметь единую точку входа по обработке заказа. Коме вышеперечисленного это позволит проще масштабироваться, создавая дополнительные экземпляры MES. Это имеет смысл, так  как длительность расчета зависит от изделия и для высокополигональной модели может длиться до 30 минут.
- Кэш для MES снижает количество запросов операторов к БД. Операторам как правило требуются данные только по последним заказам, т.к. от этого зависит их вознаграждение. При реализации записи/чтения через кеш, новые записи будут попадать в кеш постоянно что обеспечит актуальность данных и быструю выгрузку их операторам. Мы не можем позволить себе терять заказы, поэтому запись в БД производится сразу.