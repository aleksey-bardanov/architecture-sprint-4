# Выбор и настройка мониторинга в системе

## Мотивация

Повысить наблюдаемость системы необходимо для того, чтобы точно выявить места возникновения проблем. Сейчас нам известно только то, что у бизнеса возникли проблемы, связанные с существующей информационной системой. У нас есть некоторые гипотезы о том что является причиной возникновения проблем, однако предпринимать действия пока рано, требуется собрать доказательства того, что предположения верны, чтобы не потратить ресурсы разработчиков напрасно.

Мы подозреваем, что система тормозит в первую очередь из-за того, что **MES перегружен**, поэтому в первую очередь хотел бы сфокусироваться на этом сервисе. Требуется организовать мониторинг его производительности.

## Выбор подхода к мониторингу

Предлагается комбинированный подход на основе метрик USE (для оценки загруженности сервиса MES) с добавлением метрик RED (для оценки доступности системы для пользователей) :

- Utilization должна показать насколько MES загружен, чем выше процент загрузки, тем ниже вероятность, что вновь поступивший запрос будет обслужен сразу в момент поступления.
- Saturation должна однозначно показать сколько запросов ожидают обработки сервисом
- Errors (MES) должна показать эффективность обработки запросов сервисом
- Requests Rate должна показать реальную нагрузку на систему
- Duration должна показать насколько пользовательский опыт является удовлетворительным
- Errors (System) должна показать как часть пользователи сталкиваются с ошибками при обращении к системе

## Метрики

1. Метрики USE для сервиса MES:

- Utilization

  - CPU % for MES API
  - Memory Utilisation for MES API
  - Number of connections for MES db instance
  - Memory Utilisation for MES db instance
  - Size of MES db instance

- Saturation

  - Number of dead-letter-exchange letters in RabbitMQ

- Errors

  - Number of HTTP 500 for MES API
  - Number of message in flight in RabbitMQ

2. Метрики RED для всей системы

- Request Rate:

  - Number of requests (RPS) for shop API
  - Number of requests (RPS) for MES API
  - Number of requests (RPS) for CRM API

- Duration

  - Response time (latency) for shop API
  - Response time (latency) for CRM API
  - Response time (latency) for MES API

- Errors

  - Number of HTTP 500 for shop API
  - Number of HTTP 500 for CRM API
  - Number of HTTP 500 for MES API

## План действий

1. Поднять Prometeus
2. Поднять Grafana, подключить к Prometeus настроить 2 дашборда
  - для мониторинга загрузки всей системы
  - для для мониторинга загрузки сервиса MES
3. Добавить Exporter в сервисы MES, CRM и  бэкенд интернет магазина, настроить сбор метрик